<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Young Innovators STEM Lab</title>
  <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }

    #overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      z-index: 9999;
    }

    #overlay h1 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }

    #overlay p {
      font-size: 1rem;
      margin-bottom: 1.5rem;
      text-align: center;
      max-width: 80%;
    }

    #enter-ar {
      padding: 16px 40px;
      font-size: 1.2rem;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    #enter-ar:disabled {
      background: #666;
      cursor: not-allowed;
    }

    #status {
      margin-top: 1rem;
      font-size: 0.9rem;
      color: #ffcc00;
    }

    #place-btn {
      position: fixed;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      padding: 14px 36px;
      font-size: 1.1rem;
      background: #2196F3;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      z-index: 9999;
      display: none;
    }
  </style>

  <script>
    // --- Hit-test component: casts a ray from the headset to find real-world surfaces ---
    AFRAME.registerComponent('hit-test', {
      init: function () {
        this.xrHitTestSource = null;
        this.viewerSpace = null;
        this.refSpace = null;

        this.el.sceneEl.renderer.xr.addEventListener('sessionend', () => {
          this.xrHitTestSource = null;
          this.viewerSpace = null;
          this.refSpace = null;
        });

        this.el.sceneEl.renderer.xr.addEventListener('sessionstart', async () => {
          const session = this.el.sceneEl.renderer.xr.getSession();
          const refSpace = await session.requestReferenceSpace('local-floor');
          this.refSpace = refSpace;

          const viewerSpace = await session.requestReferenceSpace('viewer');
          this.viewerSpace = viewerSpace;

          session.requestHitTestSource({ space: viewerSpace }).then((source) => {
            this.xrHitTestSource = source;
          });
        });
      },

      tick: function () {
        if (!this.el.sceneEl.renderer.xr.isPresenting) return;

        const frame = this.el.sceneEl.frame;
        if (!frame || !this.xrHitTestSource || !this.refSpace) return;

        const hitTestResults = frame.getHitTestResults(this.xrHitTestSource);
        if (hitTestResults.length > 0) {
          const hit = hitTestResults[0];
          const pose = hit.getPose(this.refSpace);
          if (pose) {
            const pos = pose.transform.position;
            this.el.object3D.visible = true;
            this.el.setAttribute('position', {
              x: pos.x,
              y: pos.y,
              z: pos.z
            });
          }
        } else {
          this.el.object3D.visible = false;
        }
      }
    });

    // --- Place-model component: locks model at reticle position on button press ---
    AFRAME.registerComponent('place-model', {
      init: function () {
        this.model = document.getElementById('model');
        this.reticle = document.getElementById('reticle');
        this.placed = false;

        document.getElementById('place-btn').addEventListener('click', () => {
          if (this.reticle.object3D.visible && !this.placed) {
            const pos = this.reticle.getAttribute('position');
            this.model.setAttribute('position', pos);
            this.model.setAttribute('visible', 'true');
            this.placed = true;
            document.getElementById('place-btn').textContent = 'Reset';
          } else if (this.placed) {
            this.model.setAttribute('visible', 'false');
            this.placed = false;
            document.getElementById('place-btn').textContent = 'Place Model';
          }
        });
      }
    });
  </script>
</head>

<body>
  <!-- Startup overlay -->
  <div id="overlay">
    <h1>Young Innovators STEM Lab</h1>
    <p>Put on your Meta Quest 3S and tap "Enter AR" to start the passthrough AR experience.</p>
    <button id="enter-ar" disabled>Enter AR</button>
    <div id="status">Checking WebXR support...</div>
  </div>

  <!-- Place button (shown during AR session) -->
  <button id="place-btn">Place Model</button>

  <!-- A-Frame scene configured for WebXR immersive-ar -->
  <a-scene
    webxr="requiredFeatures: hit-test, local-floor; referenceSpaceType: local-floor;"
    renderer="alpha: true; colorManagement: true; physicallyCorrectLights: true;"
    vr-mode-ui="enabled: false"
    place-model>

    <!-- Lighting -->
    <a-entity light="type: ambient; color: #fff; intensity: 0.6;"></a-entity>
    <a-entity light="type: directional; color: #fff; intensity: 0.8;" position="1 2 1"></a-entity>

    <!-- Hit-test reticle (ring on detected surfaces) -->
    <a-entity id="reticle" hit-test visible="false">
      <a-ring color="#2196F3" radius-inner="0.04" radius-outer="0.06"
        rotation="-90 0 0" material="shader: flat; opacity: 0.7;"></a-ring>
    </a-entity>

    <!-- 3D Model (hidden until placed) -->
    <a-entity id="model" visible="false" scale="0.05 0.05 0.05"
      gltf-model="https://raw.githack.com/AR-js-org/AR.js/master/aframe/examples/image-tracking/nft/trex/scene.gltf"
      animation="property: rotation; to: 0 360 0; loop: true; dur: 10000; easing: linear;">
    </a-entity>

    <!-- Camera (managed by WebXR on Quest) -->
    <a-entity camera></a-entity>
  </a-scene>

  <script>
    // Check for WebXR immersive-ar support and wire up the Enter AR button
    (async function () {
      const enterBtn = document.getElementById('enter-ar');
      const status = document.getElementById('status');
      const overlay = document.getElementById('overlay');
      const placeBtn = document.getElementById('place-btn');

      if (!navigator.xr) {
        status.textContent = 'WebXR not supported on this browser/device.';
        return;
      }

      const supported = await navigator.xr.isSessionSupported('immersive-ar');
      if (!supported) {
        status.textContent = 'Immersive AR not supported. Open this page in Meta Quest Browser.';
        return;
      }

      status.textContent = 'AR is supported! Put on your headset and tap the button.';
      enterBtn.disabled = false;

      enterBtn.addEventListener('click', async () => {
        try {
          const scene = document.querySelector('a-scene');
          // A-Frame handles session request through its enterAR method
          if (scene.enterAR) {
            await scene.enterAR();
          } else {
            // Fallback: request session directly
            const session = await navigator.xr.requestSession('immersive-ar', {
              requiredFeatures: ['hit-test', 'local-floor']
            });
            scene.renderer.xr.setSession(session);
          }
          overlay.style.display = 'none';
          placeBtn.style.display = 'block';
        } catch (e) {
          status.textContent = 'Failed to start AR: ' + e.message;
        }
      });
    })();
  </script>
</body>

</html>